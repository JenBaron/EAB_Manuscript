---
title: "Model Revision"
author: "Jen Baron"
date: 'April 18, 2019'
output: html_document
---

**Read First**
This is the same code as the original analysis, but I'm now modelling the raw amount of buckthorn (instead of the relative abundance)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE}
library(tidyverse)
library(nlme)
library(lme4)
library(glmmTMB)
library(RColorBrewer)
library(colorspace)
library(gridExtra)
library(DHARMa)
```


## Ecological Integrity

### Read EI Data

```{r}
EI7 <- read.csv("EI.csv")
str(EI7)
```

### Run PCA

```{r}
EI7 %>% select(Edge.Distance, Fragment.Size, Percent.Tree, Shade.Tolerance.Site) -> EI.data

prcomp(EI.data, scale. = TRUE) -> EI.pca

summary(EI.pca) #PCA summary

biplot(EI.pca) #PCA biplot

#Save scores
PC1 <- predict(EI.pca)[,1]
PC2 <- predict(EI.pca)[,2]
```

```{r}
rescale.U <- rep(EI.pca$sdev, each = length(EI.pca$sdev)) #get lengths

U.scale2 <- EI.pca$rotation * rescale.U #multiply lengths by sqrt SD

round(U.scale2^2,2) #variability in each variable for each PC
```


### QQ plots for PCA

```{r}
qqnorm(EI.data[,1]);qqline(EI.data[,1])
qqnorm(EI.data[,2]);qqline(EI.data[,2])
qqnorm(EI.data[,3]);qqline(EI.data[,3])
qqnorm(EI.data[,4]);qqline(EI.data[,4])
```



## Modelling Buckthorn

### Read in Understory & Shrub Data

```{r}
understory.f <- read.csv("understory_final.csv") %>% select(-"X")
shrubs.f <- read.csv("shrubs_final.csv") %>% select(-"X")

shrubs.EI <- full_join(shrubs.f, EI7, by = c("Location", "Category", "ID")) 
shrubs.EI$Category <- as.factor(shrubs.EI$Category)
names(shrubs.EI) <- sub(" ", ".", names(shrubs.EI)) #Replace spaces with .
#add values from PCA
shrubs.EI$PC1 <- PC1
shrubs.EI$PC2 <- PC2
str(shrubs.EI)
```


Check distribution
```{r}
hist(shrubs.f$Buckthorn) #left skewed

sum(shrubs.EI$Buckthorn > 0) / nrow(shrubs.EI) # 56% zeros

```

```{r}
shrubs.EI$Category <- relevel(shrubs.EI$Category, ref = "Non-Gap") #re-level to set non-gap as reference condition
```


#### Apply a Poission Generalized MM  & check for overdispersion
```{r}
shrubs.B1 <- glmer(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), family = poisson, data = shrubs.EI)

E1 <- resid(shrubs.B1, type = "pearson")
N <- nrow(shrubs.EI)
p <- length(fixef(shrubs.B1)) + 1
sum(E1^2) / (N - p)
```

Yea, that's way over 1 (super overdispersed)


#### Apply a negative binomial GLMM  & check for overdispersion
```{r}
shrubs.B2 <- glmmTMB(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), family = "nbinom2", data = shrubs.EI)

E3 <- resid(shrubs.B2, type = "pearson")
N <- nrow(shrubs.EI)
p <- length(fixef(shrubs.B2)$cond) + 1 + 1 #why is this + 1 + 1
sum(E3^2) / (N - p)
```

Now likely underdispersed, but a little better than before


#### Model Selection

Select ecological integrity (PC1 / PC2) with and without gap area

```{r}
#PC1 without gap area
shrubsfit.Ba <- glmmTMB(Buckthorn ~ Category * PC1 + (1 | Location), family = "nbinom2", data = shrubs.EI)
#PC1 with gap area
shrubsfit.Bb <- glmmTMB(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), family = "nbinom2", data = shrubs.EI)
#PC2 without gap area
shrubsfit.Bc <- glmmTMB(Buckthorn ~ Category * PC2 + (1 | Location), family = "nbinom2", data = shrubs.EI)
#PC2 with gap area
shrubsfit.Bd <- glmmTMB(Buckthorn ~ Category * PC2 + Gap.Area.Site + (1 | Location), family = "nbinom2", data = shrubs.EI)
```


```{r}
AIC(shrubsfit.Ba, shrubsfit.Bb, shrubsfit.Bc, shrubsfit.Bd)
```

PC1 with gap area (shrubsfit.Bb) is best

### Test interaction

```{r}
shrubsfit.Bb <- glmmTMB(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), family = "nbinom2", data = shrubs.EI)
shrubsfit.Bb.no.inter <- glmmTMB(Buckthorn ~ Category + PC1 + Gap.Area.Site + (1 | Location), family = "nbinom2", data = shrubs.EI)
shrubsfit.null <- glmmTMB(Buckthorn ~ 1 + (1 | Location), family = "nbinom2", data = shrubs.EI)
anova(shrubsfit.Bb, shrubsfit.Bb.no.inter)
AIC(shrubsfit.Bb, shrubsfit.Bb.no.inter, shrubsfit.null)
```

p-value for interaction is now 0.06 (still marginally significant)


```{r}
summary(shrubs.B2)
```

Effect of gap area now significant



### Model Validation

**Residuals vs fitted values**

There are two types of fitted values for a GLM - the "link" predictions are estimates of $\eta$ and the response predictions are estimates of $\mu$.

```{r}
shrubs.EI$res <- residuals(shrubsfit.Bb, type = "pearson")
shrubs.EI$fit <- predict(shrubsfit.Bb, type = "response")

ggplot(shrubs.EI,aes(x = fit, y = res)) + 
  geom_point() + geom_smooth()
```

**Residuals vs X**

```{r}
ggplot(shrubs.EI, aes(x = PC1, y = res)) + 
  geom_point() + geom_smooth()
``` 

```{r}
simulationOutput1 <- simulateResiduals(fittedModel = shrubsfit.Bb, n = 1000)
plotSimulatedResiduals(simulationOutput = simulationOutput1)
par(mfrow = c(1,3))
```


### Plot Model Predictions

This doesn't work anymore because gap area is in the model - fix

```{r}
non.min <- min(subset(shrubs.EI$PC1, shrubs.EI$Category == "Non-Gap"))
non.max<- max(subset(shrubs.EI$PC1, shrubs.EI$Category == "Non-Gap"))
EAB.min <- min(subset(shrubs.EI$PC1, shrubs.EI$Category == "EAB Gap"))
EAB.max <- max(subset(shrubs.EI$PC1, shrubs.EI$Category == "EAB Gap"))
other.min <- min(subset(shrubs.EI$PC1, shrubs.EI$Category == "Other Gap"))
other.max <- max(subset(shrubs.EI$PC1, shrubs.EI$Category == "Other Gap"))




pred <- data.frame(PC1 = c(seq(EAB.min, EAB.max, length.out = 100), 
                               seq(other.min, other.max, length.out = 100), 
                                   seq(non.min, non.max, length.out = 100)),
                   Category = c(rep("EAB Gap", 100), rep("Other Gap", 100), rep("Non-Gap", 100)),
                   Gap.Area.Site = rep(mean(shrubs.EI$Gap.Area.Site),300), # Added gap area
                   Location = rep(NA, 300))

pred$fit <- predict(shrubsfit.Bb, newdata = pred, se.fit = TRUE, type = "link")$fit
pred$se <- predict(shrubsfit.Bb, newdata = pred, se.fit = TRUE, type = "link")$se.fit
str(pred)

pred.upr <- pred$fit + 1.96 * pred$se
pred.lwr <- pred$fit - 1.96 * pred$se

pred$upr <- ifelse(exp(pred.upr) < 100, exp(pred.upr), 100)
pred$lwr <- ifelse(exp(pred.lwr) > 0, exp(pred.lwr), 0)

pred$mean <- exp(pred$fit)
```


```{r}
mypalette2 = c(brewer.pal(12, "Paired")[c(12,2,4)])
str(pred)
```

```{r}
shrubs.EI$Category = factor(shrubs.EI$Category, levels=c("EAB Gap", "Other Gap", "Non-Gap"))
pred$Category = factor(pred$Category, levels=c("EAB Gap", "Other Gap", "Non-Gap"))

fig.EI <- ggplot(pred, aes(x = PC1, y = mean)) +
    geom_ribbon(aes(x = PC1, ymin = lwr, ymax = upr, fill = Category), alpha = 0.15) +
      geom_point(data = shrubs.EI, aes(x = PC1, y = Buckthorn, col = Category), alpha = 0.6) + 
  geom_line(aes(col = Category), size = 1, alpha = 0.8) +
  labs(x = "Ecological Integrity",
       y = "Buckthorn (%)",
       col = "Category") +
    scale_colour_manual(values = mypalette2) +
  scale_fill_manual(values = mypalette2) +
    theme_classic() +
  theme(axis.text.x = element_text(size = 10, face = "bold"),  
        axis.title = element_text(size = 13),
          axis.text.y = element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 13),
        legend.text=element_text(size = 10)) 
```

Book: Mixed Effects Models and Extensions in Ecology with R (Chpt 11)
May still get overdispersion with poisson or negative binomial because of all the zeros
There are two further types of models for dealing with count based stuff: zero-altered and zero-inflated (p. 273)

GLM combined with poisson/negative binomial/zero-inflated poisson/zero-inflated negative binomial - complicated in the sense that the algorithms must be different
It's possible the poisson / negative binomial will take care of it
Look at residuals and see if things improve
If not, the next step to take is to try a zero-inflated model




## Zero inflated

```{r}
shrubs.0infl <- glmmTMB(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), ziformula = ~., family = "nbinom2", data = shrubs.EI)

shrubs.hurdle <- glmmTMB(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), ziformula = ~., family = "truncated_nbinom2", data = shrubs.EI)

summary(shrubs.0infl)
summary(shrubs.hurdle)

AIC(shrubs.0infl, shrubs.hurdle, shrubs.B2) # Better than neg binomial 




## Backwards selection



shrubs.0infl2 <- glmmTMB(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), 
                        ziformula = ~ Category + PC1 + Gap.Area.Site + (1 | Location), family = "nbinom2", data = shrubs.EI)

shrubs.0infl3 <- glmmTMB(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), 
                        ziformula = ~ Category * PC1 + (1 | Location), family = "nbinom2", data = shrubs.EI)

AIC(shrubs.0infl, shrubs.0infl2, shrubs.0infl3)

#step 2 


shrubs.0infl4 <- glmmTMB(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), 
                        ziformula = ~  PC1 + Gap.Area.Site + (1 | Location), family = "nbinom2", data = shrubs.EI)
shrubs.0infl5 <- glmmTMB(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), 
                        ziformula = ~ Category  + Gap.Area.Site + (1 | Location), family = "nbinom2", data = shrubs.EI)
shrubs.0infl6 <- glmmTMB(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), 
                        ziformula = ~ Category + PC1  + (1 | Location), family = "nbinom2", data = shrubs.EI)


AIC(shrubs.0infl2, shrubs.0infl4, shrubs.0infl5, shrubs.0infl6)

# step 3


shrubs.0infl7 <- glmmTMB(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), 
                        ziformula = ~ Category  + (1 | Location), family = "nbinom2", data = shrubs.EI)

shrubs.0infl8 <- glmmTMB(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), 
                        ziformula = ~ PC1  + (1 | Location), family = "nbinom2", data = shrubs.EI)


AIC(shrubs.0infl6, shrubs.0infl7, shrubs.0infl8)

shrubs.0infl7a <- glmmTMB(Buckthorn ~ Category * PC1 + Gap.Area.Site + (1 | Location), 
                        ziformula = ~ 1  + (1 | Location), family = "nbinom2", data = shrubs.EI)


AIC(shrubs.0infl7, shrubs.0infl7a)

## Test interaction


shrubs.0infl9 <- glmmTMB(Buckthorn ~ Category + PC1 + Gap.Area.Site + (1 | Location), 
                        ziformula = ~ Category  + (1 | Location), family = "nbinom2", data = shrubs.EI)
shrubs.0infl10 <- glmmTMB(Buckthorn ~ Category * PC1  + (1 | Location), 
                        ziformula = ~ Category  + (1 | Location), family = "nbinom2", data = shrubs.EI)


AIC(shrubs.0infl7, shrubs.0infl9, shrubs.0infl10)
anova(shrubs.0infl7, shrubs.0infl9, shrubs.0infl10, shrubs.B2)


shrubs.hurdle10 <- glmmTMB(Buckthorn ~ Category * PC1  + (1 | Location), 
                        ziformula = ~ Category  + (1 | Location), family = "truncated_nbinom2", data = shrubs.EI)

shrubs.hurdle11 <- glmmTMB(Buckthorn ~ Category + PC1  + (1 | Location), 
                        ziformula = ~ Category  + (1 | Location), family = "truncated_nbinom2", data = shrubs.EI)


AIC(shrubs.0infl10, shrubs.0infl11)

summary(shrubs.0infl10)





```



